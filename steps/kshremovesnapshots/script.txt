$VM = '{targetServer.name}'

function printSnapShots() {
    $SNAP_SHOTS = Get-VMSnapshot -VMName $VM
    
    $NUM_SNAPSHOTS = ($SNAP_SHOTS | measure).Count
    
    Write-Host "There are the $NUM_SNAPSHOTS snapshots for $VM"
    
    $i = 1
    foreach ($SNAP_SHOT in $SNAP_SHOTS)
    {
        $SNAP_SHOT_NAME = $SNAP_SHOT."Name"
        Write-Host "$i. $SNAP_SHOT_NAME"
    }
}

function checkSnapShotsDeleted() {

    $DELETED = $false
    
    for ($i = 0; $i -lt 10; $i++) {
        # Give time for the snapshots to be deleted on disk
        Start-Sleep -Seconds 3
        
        printSnapShots
        
        $SNAP_SHOTS = Get-VMSnapshot -VMName $VM
        $NUM_SNAPSHOTS = ($SNAP_SHOTS | measure).Count
        
        if ($NUM_SNAPSHOTS -gt 0) {
            Write-Host "Waiting"
        } else {
            Write-Host "All snapshots for $VM removed."
            $DELETED = $true
            break
        }
    }
    
    if (-Not $DELETED) {
        Write-Host "Error: Could not delete snapshots."
        exit 1        
    }
}

printSnapShots

$SNAP_SHOTS = Get-VMSnapshot -VMName $VM
$NUM_SNAPSHOTS = ($SNAP_SHOTS | measure).Count

if ($NUM_SNAPSHOTS -gt 0) {

    Write-Host "Removing snapshots for $VM."
    Get-VM -Name $VM | Remove-VMSnapshot -Name *
    
    checkSnapShotsDeleted
}