
<!doctype html>
<html lang="en">




<head>
    <title>How to Hyper-V Blueprints - Attune Automation</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="title"
          content="How to Hyper-V Blueprints - Attune Automation">
    <meta name="description"
          content="">
    <meta name="robots"
          content="follow, index, max-snippet:-1, max-video-preview:-1, max-image-preview:large">

    <meta property="og:locale" content="en_AU" />
    <meta property="og:type" content="article" />
    <meta property="og:title"
          content="HowTo Hyper-V Blueprints - Attune Automation" />
    <meta property="og:description" content="" />
    <meta property="og:site_name" content="Attune Automation" />
    <meta property="article:section" content="IT Instruction" />

    <meta name="twitter:title"
          content="How to Hyper-V Blueprints - Attune Automation" />
    <meta name="twitter:description" content="" />

    <link rel="icon" href="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-32x32.png" sizes="32x32">
    <link rel="icon" href="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-192x192.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-180x180.png">
    <meta name="msapplication-TileImage" content="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-270x270.png">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
          crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="../styles/style.css">

</head>


<body>

<!-- Project breadcrumbs -->

<!-- Project breadcrumbs -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb m-0">
        <li class="breadcrumb-item" aria-current="page">
            <a
                href="https://www.servertribe.com/"
                target="_blank">
                ServerTribe
            </a>
        </li>
        <li class="breadcrumb-item" aria-current="page">
            <a
                href="https://github.com/attune-Automation/"
                target="_blank">
                Attune Automation Projects
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="../index.html">
            Hyper-V Kickstarts
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <strong>Hyper-V Blueprints</strong>
        </li>
    </ol>
</nav>

<!-- Blueprint Header -->

<div class="container px-0">
    <!-- Blueprint name and description -->
    <div class="row pt-5">
        <div class="col px-0">
            <h1 class="text-left">
                How to Hyper-V Blueprints
            </h1>
        </div>
    </div>

<!-- Blueprint Description -->
    <div class="row pt-4">
        <div class="col-6 px-0">
            <h6 class="text-left">
                This documentation is generated by
                <a href="https://www.servertribe.com/"
                    class="badge badge-primary"
                    target="_blank">
                    Attune
                </a>
            </h6>
        </div>
        <div class="col-6 align-self-end text-right px-0">
            <h6 class="text-right">
                <a href="https://www.youtube.com/@servertribe"
                    class="badge badge-secondary"
                    target="_blank">
                    YouTube
                </a>
                <a href="https://github.com/Attune-Automation"
                    class="badge badge-secondary"
                    target="_blank">
                    GitHub
                </a>
                <a href="https://discord.com/invite/3YpJsagqUn"
                    class="badge badge-secondary"
                    target="_blank">
                    Discord
                </a>
                <a href="https://www.linkedin.com/company/servertribe/"
                    class="badge badge-secondary"
                    target="_blank">
                    LinkedIn
                </a>
                <a href="http://doc.servertribe.com/"
                    class="badge badge-secondary"
                    target="_blank">
                    Documentation
                </a>
            </h6>
        </div>
    </div>
    <hr>
</div>

<div class="documentation">
    <div class="container px-0">
        <div class="row">

<!-- Blueprint ToC -->


            <div class="col-lg-2 px-0 pr-5">
                <div class="container px-0 pt-3 sticky-top">
                    <h6 class="pb-2">
                        <strong>Contents</strong>
                    </h6>
                    <h6 class="text-muted">
                        <a href="#top">
                            <strong>Hyper-V Blueprints</strong>
                        </a>
                    </h6>


    
        

                    <h6 class="text-muted pt-2">
                        <a href="#kickstartcentos84hyperv">
                            <strong>Step 1 -</strong> Kickstart CentOS8.4+HyperV
                        </a>
                    </h6>
    
        

                    <h6 class="text-muted pt-2">
                        <a href="#kscleanbuildfiles">
                            <strong>Step 1.1 -</strong> KS Clean Build Files
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kscentos8deploybootisohyperv">
                            <strong>Step 1.2 -</strong> KS CentOS8 Deploy Boot ISO Hyper-V
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kscentos88deploykickstartconfig">
                            <strong>Step 1.3 -</strong> KS CentOS8 8 Deploy Kickstart Config
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kscentos8createbinarydvd">
                            <strong>Step 1.4 -</strong> KS CentOS8 Create Binary DVD
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshypervrecreatelinvirtualmachine">
                            <strong>Step 1.5 -</strong> KS Hyper-V Recreate Lin Virtual Machine
                        </a>
                    </h6>
    
        

                    <h6 class="text-muted pt-2">
                        <a href="#kshstopvm">
                            <strong>Step 1.5.1 -</strong> KSH Stop VM
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshdeletevm">
                            <strong>Step 1.5.2 -</strong> KSH Delete VM
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshdeleteharddisk">
                            <strong>Step 1.5.3 -</strong> KSH Delete Hard Disk
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshcreatevm">
                            <strong>Step 1.5.4 -</strong> KSH Create VM
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshsetbootorder">
                            <strong>Step 1.5.5 -</strong> KSH Set Boot Order
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#ksdeleteisoonhypervhost">
                            <strong>Step 1.5.6 -</strong> KS Delete ISO On Hyper-V Host
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshcreatekickstartfolder">
                            <strong>Step 1.5.7 -</strong> KSH Create Kickstart Folder
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshhypervpulliso">
                            <strong>Step 1.5.8 -</strong> KSH Hyper-V Pull ISO
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshchecksha256sum">
                            <strong>Step 1.5.9 -</strong> KSH Check SHA256 Sum
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshloadiso">
                            <strong>Step 1.5.10 -</strong> KSH Load ISO
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#ksaddvmdvddriveforgeneration2">
                            <strong>Step 1.5.11 -</strong> KS Add-VMDvdDrive for Generation 2
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshsetbootorderforgeneration2">
                            <strong>Step 1.5.12 -</strong> KSH Set Boot Order for Generation 2
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshboottoiso">
                            <strong>Step 1.5.13 -</strong> KSH Boot to ISO
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kssshwait">
                            <strong>Step 1.5.14 -</strong> KS SSH Wait
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshunloadisofromvm">
                            <strong>Step 1.5.15 -</strong> KSH Unload ISO from VM
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshremovevmdvddriveforgeneration2">
                            <strong>Step 1.5.16 -</strong> KSH Remove-VMDvdDrive for Generation 2
                        </a>
                    </h6>


        

                    <h6 class="text-muted pt-2">
                        <a href="#kscleanbuildfiles">
                            <strong>Step 1.6 -</strong> KS Clean Build Files
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#ksdeleteisoonhypervhost">
                            <strong>Step 1.7 -</strong> KS Delete ISO On Hyper-V Host
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#linreboot">
                            <strong>Step 1.8 -</strong> LIN Reboot
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kssshwait">
                            <strong>Step 1.9 -</strong> KS SSH Wait
                        </a>
                    </h6>


        

                    <h6 class="text-muted pt-2">
                        <a href="#winpekickstartwin10hyperv">
                            <strong>Step 2 -</strong> WinPE Kickstart Win10+HyperV
                        </a>
                    </h6>
    
        

                    <h6 class="text-muted pt-2">
                        <a href="#kscleanbuildfiles">
                            <strong>Step 2.1 -</strong> KS Clean Build Files
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#ksextractwinpeisoparentlink">
                            <strong>Step 2.2 -</strong> KS Extract WinPE ISO - Parent (Link)
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshypervdeploywin10unattendedconfiglink">
                            <strong>Step 2.3 -</strong> KS Hyper-V Deploy Win10 Unattended Config (Link)
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#modifywinpebootwimforwin10link">
                            <strong>Step 2.4 -</strong> Modify WinPE boot.wim for Win10 (Link)
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kswinpecreatebootisoparentlink">
                            <strong>Step 2.5 -</strong> KS WinPE Create Boot ISO - parent (Link)
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshypervrecreatewinvirtualmachinelink">
                            <strong>Step 2.6 -</strong> KS Hyper-V Recreate Win Virtual Machine (Link)
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kscleanbuildfiles">
                            <strong>Step 2.7 -</strong> KS Clean Build Files
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#ksdeleteisoonhypervhost">
                            <strong>Step 2.8 -</strong> KS Delete ISO On Hyper-V Host
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#winrebootlink">
                            <strong>Step 2.9 -</strong> WIN Reboot (Link)
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#winrmhttpswait120s">
                            <strong>Step 2.10 -</strong> WinRM HTTPS Wait 120s
                        </a>
                    </h6>


        

                    <h6 class="text-muted pt-2">
                        <a href="#winpekickstartwin2019hyperv">
                            <strong>Step 3 -</strong> WinPE Kickstart Win2019+HyperV
                        </a>
                    </h6>
    
        

                    <h6 class="text-muted pt-2">
                        <a href="#kscleanbuildfiles">
                            <strong>Step 3.1 -</strong> KS Clean Build Files
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#winpedeploywinpefilesforhyperv">
                            <strong>Step 3.2 -</strong> WinPE Deploy WinPE Files for HyperV
                        </a>
                    </h6>
    
        

                    <h6 class="text-muted pt-2">
                        <a href="#kswimlibunmountbootwimifmounted">
                            <strong>Step 3.2.1 -</strong> KS wimlib Unmount boot.wim if Mounted
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kswin2019deploywinpeisohyperv">
                            <strong>Step 3.2.2 -</strong> KS Win2019 Deploy WinPE ISO Hyper-V
                        </a>
                    </h6>


        

                    <h6 class="text-muted pt-2">
                        <a href="#ksextractwinpeisoparentlink">
                            <strong>Step 3.3 -</strong> KS Extract WinPE ISO - Parent (Link)
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshypervdeploywin2019unattendedconfiglink">
                            <strong>Step 3.4 -</strong> KS Hyper-V Deploy Win2019 Unattended Config (Link)
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#modifywinpebootwimfor2016link">
                            <strong>Step 3.5 -</strong> Modify WinPE boot.wim for 2016 (Link)
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kswinpecreatebootisoparentlink">
                            <strong>Step 3.6 -</strong> KS WinPE Create Boot ISO - parent (Link)
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kshypervrecreatewinvirtualmachinelink">
                            <strong>Step 3.7 -</strong> KS Hyper-V Recreate Win Virtual Machine (Link)
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#kscleanbuildfiles">
                            <strong>Step 3.8 -</strong> KS Clean Build Files
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#ksdeleteisoonhypervhost">
                            <strong>Step 3.9 -</strong> KS Delete ISO On Hyper-V Host
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#winrebootlink">
                            <strong>Step 3.10 -</strong> WIN Reboot (Link)
                        </a>
                    </h6>

        

                    <h6 class="text-muted pt-2">
                        <a href="#winrmhttpswait120s">
                            <strong>Step 3.11 -</strong> WinRM HTTPS Wait 120s
                        </a>
                    </h6>



                </div>
            </div>

<!-- Blueprint Contents -->
            <div class="col-lg-8 pt-3">
                <div class="container">


        <div class="blueprint-description jumbotron">
            <h2 class="display-3 text-center">
                Automate This
            </h2>
            <p class="lead text-center">
                Use the <strong>Attune GUI</strong> for your Scripts
            </p>
            <p class="lead">
                <ol>
                    <a href="https://www.servertribe.com/download-attune-registration/"
                        target="_blank">
                        <span class="badge badge-primary">1</span>
                        Download Attune
                        <i class="fa-solid fa-download fa-beat-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://github.com/attune-Automation/"
                        target="_blank">
                        <span class="badge badge-primary">2</span>
                         Copy the Attune Project URL
                         <i class="fa-brands fa-github fa-fade"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://servertribe-attune.readthedocs.io/en/latest/howto/design_workspace/clone_project.html"
                        target="_blank">
                        <span class="badge badge-primary">3</span>
                        Clone the Project in Attune
                         <i class="fa-solid fa-book fa-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://www.youtube.com/watch?v=GCWDI29rDV0"
                        target="_blank">
                        <span class="badge badge-primary">4</span>
                        Plan your Job(s)
                        <i class="fa-brands fa-youtube fa-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://www.youtube.com/watch?v=b7DhFcURkZg"
                        target="_blank">
                        <span class="badge badge-primary">5</span>
                        Run your Job(s)
                        <i class="fa-brands fa-youtube fa-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
            </p>
            <p class="lead text-center">
                You've automated: <strong>Hyper-V Blueprints</strong>
            </p>
            <hr class="my-4 text-center">
            <div class="col px-0">
                <p class="text-center">
                    Get the most out of automation with our get started
                    videos, product demonstrations, and more.
                </p>
                <p class="lead text-center">
                    <a class="btn btn-primary btn-lg"
                       href="https://www.servertribe.com/learn/"
                       target="_blank"
                       role="button">
                        Learn Attune Automation
                    </a>
                </p>
            </div>
        </div>

        <div class="row">
            <p>The following steps will guide you through the manual process.</p>
        </div>

<!-- Blueprint Steps -->


        



                    <div class="row pt-5">
                        <h3 id="kickstartcentos84hyperv">
                            <a href="#kickstartcentos84hyperv">
                                <strong>Step 1 -</strong> Kickstart CentOS8.4+HyperV
                            </a>
                        </h3>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>





    




    



                    <div class="row pt-5">
                        <h4 id="kscleanbuildfiles">
                            <a href="#kscleanbuildfiles">
                                <strong>Step 1.1 -</strong> KS Clean Build Files
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {linuxattuneuser}@{attuneosbuildserver}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
DIR=&quot;{ksVmwareAttuneBaseDir}/build-{targetServer.fqn}&quot;
[[ -d ${DIR} ]] &amp;&amp; rm -rf ${DIR} &amp;&amp; echo &quot;Removed ${DIR}&quot; || \
    echo &quot;No directory to remove.&quot;

ISO=&quot;{ksVmwareAttuneBaseDir}/kickstart_{targetServer.fqn}.iso&quot;
[[ -f ${ISO} ]] &amp;&amp; rm -fv ${ISO} || echo &quot;No ISO to remove.&quot;
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kscentos8deploybootisohyperv">
                            <a href="#kscentos8deploybootisohyperv">
                                <strong>Step 1.2 -</strong> KS CentOS8 Deploy Boot ISO Hyper-V
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    

    



    <div class="row">
        <p>
            <p>This is from Kean's macbook attune on project "Build Peek V3 Cento08 Dev Node on Parallels" in file archive "CentOS8 Boot ISO v8.4.2105".</p>
        </p>
        <p>
            Copy the File(s)
            <strong>CentOS8_Boot_ISO_v842105.tar</strong>
            to the target node.
        </p>
        <p>
            <strong>Extract and deploy the File(s)</strong> here:
        </p>
    </div>
    <div class="row py-1">
        <code class="language-bash">
{ksVmwareAttuneBaseDir}/build-{targetServer.fqn}, relative to the home directory
        </code>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kscentos88deploykickstartconfig">
                            <a href="#kscentos88deploykickstartconfig">
                                <strong>Step 1.3 -</strong> KS CentOS8 8 Deploy Kickstart Config
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    

    



    <div class="row">
        <p>
            <p>https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/performing_an_advanced_rhel_installation/kickstart-commands-and-options-reference_installing-rhel-as-an-experienced-user</p>
        </p>
        <p>
            Copy the File(s)
            <strong>CentOS8_Kickstart_Config.tar</strong>
            to the target node.
        </p>
        <p>
        </p>
    </div>
    <div class="row py-1">
        <code class="language-bash">
{ksVmwareAttuneBaseDir}/build-{targetServer.fqn}, relative to the home directory
        </code>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kscentos8createbinarydvd">
                            <a href="#kscentos8createbinarydvd">
                                <strong>Step 1.4 -</strong> KS CentOS8 Create Binary DVD
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
cd {ksVmwareAttuneBaseDir}/build-{targetServer.fqn}

mkisofs -o {ksVmwareAttuneBaseDir}/kickstart_{targetServer.fqn}.iso \
  -b isolinux/isolinux.bin -c isolinux/boot.cat \
  -no-emul-boot -boot-load-size 4 -boot-info-table -J -R -V &quot;KS_RHEL&quot; .
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h3 id="kshypervrecreatelinvirtualmachine">
                            <a href="#kshypervrecreatelinvirtualmachine">
                                <strong>Step 1.5 -</strong> KS Hyper-V Recreate Lin Virtual Machine
                            </a>
                        </h3>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>





    




    



                    <div class="row pt-5">
                        <h4 id="kshstopvm">
                            <a href="#kshstopvm">
                                <strong>Step 1.5.1 -</strong> KSH Stop VM
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>










                        <div class="row">
                            <p>
                                Connect via RDP:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
mstsc /admin /v:{hypervhost}
                            </code>
                        </div>
                        <div class="row">
                            <p>
                                Login as user {hypervhostuser} and open a
                                command prompt.
                            </p>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$VM=&#x27;{targetServer.name}&#x27;

Write-Host &quot;Deleting VM : $VM&quot;

$i=0
$found=$false

Get-VM | ForEach-Object {
   if ($_.Name -eq $VM) {
       Write-Host &quot;VM $VM found&quot;
       $found=$true
       return
   }
   $i++
}       

if ($found -eq $true) {
    Write-Host &quot;Checking whether VM $VM is running&quot;
    
    $state = (Get-VM $VM).state
    
    Write-Host &quot;VM state=$state&quot;
    
    if ($state -eq &quot;Running&quot;) {
        Write-Host &quot;VM is running, shutting it down&quot;.
        Stop-VM -Name $VM
        
        $state = (Get-VM $VM).state
        Write-Host &quot;VM state=$state&quot;
        
        if ($state -eq &quot;Off&quot;) {
            Write-Host &quot;VM stopped successfully&quot;
        } else {
            Write-Error &quot;VM stop failed&quot; -ErrorAction Stop
        }
    } else {
        Write-Host &quot;VM is stopped. Skipping.&quot;
    }
} else {
    Write-Host &quot;No VM $VM found. Skipping.&quot;
}
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kshdeletevm">
                            <a href="#kshdeletevm">
                                <strong>Step 1.5.2 -</strong> KSH Delete VM
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$VM=&#x27;{targetServer.name}&#x27;

Write-Host &quot;Deleting VM : $VM&quot;

$i=0
$found=$false

Get-VM | ForEach-Object {
   if ($_.Name -eq $VM) {
       Write-Host &quot;VM $VM found&quot;
       $found=$true
       
       Remove-VMHardDiskDrive -VMName $_.Name -ControllerType IDE -ControllerNumber 0 -ControllerLocation 0
       Remove-VM -Name $_.Name -Force
       
       if ($? -eq $true) {
           Write-Host &quot;Removed VM $VM sucessfully&quot;
       } else {
           Write-Host &quot;Failed to remove VM $VM&quot;       
       }
       return
   }
   $i++
}

if ($found -eq $false) {
    Write-Host &quot;No VM, continuing.&quot;
}
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kshdeleteharddisk">
                            <a href="#kshdeleteharddisk">
                                <strong>Step 1.5.3 -</strong> KSH Delete Hard Disk
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
# Directory of VM&#x27;s virtual disk
cd &quot;{virtualHardDiskFolder}&quot;

# name of VM, this just applies in Windows, it isn&#x27;t applied to the OS guest itself.
$VM = &#x27;{targetServer.name}&#x27;

# Remove Hard Disk VM Files on Hyper-V Server

# Path of the VM&#x27;s virtual disk
# The full path will look something like &quot;C:\Users\Public\Documents\Hyper-V\Virtual Hard Disks\{targetServer.name}-disk1.vhdx&quot;

$HARD_DISKS = Get-ChildItem -Path . -Filter &quot;$VM-disk*.vhdx&quot;
Write-Host &quot;$HARD_DISKS&quot;

$i = 1
foreach ($HARD_DISK in $HARD_DISKS)
{
    Write-Host &quot;$i. $HARD_DISK&quot;
    Remove-Item $HARD_DISK
    Write-Host &quot;Deleted disk {virtualHardDiskFolder}\$HARD_DISK&quot;
    $i++
}
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kshcreatevm">
                            <a href="#kshcreatevm">
                                <strong>Step 1.5.4 -</strong> KSH Create VM
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            <p>Assumes we have an external Hyper-V switch called "External VM Switch" at line 10.</p>
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
# This script is in two parts. 

# Part 1: First we declare the variables to be applied.
# ---------------------------------------------------------

# name of VM, this just applies in Windows, it isn&#x27;t applied to the OS guest itself.
$VM = &#x27;{targetServer.name}&#x27;

# name of your local vswitch
$VM_switch = (Get-VMSwitch -Name &quot;External VM Switch&quot;).Name

# Number of CPUs
$cpu =  &quot;{ksVmCpuCount}&quot;

# RAM in bytes
$ram_bytes = {ksVmRamSizeGb} * 1024 * 1024 * 1024

# Path of the VM&#x27;s virtual disk
# The full path will look something like 
# &quot;C:\ProgramData\Microsoft\Windows\Virtual Hard Disks{targetServer.name}-disk1.vhdx&quot;
$path_to_disk = &quot;{virtualHardDiskFolder}\$VM-disk1.vhdx&quot;

# Set 100GB
# VM storage, not a string, PowerShell converts this to bytes once stored into $disk_size.
$disk_size = 100GB

# Part 2: The next part are the PowerShell commands
# ---------------------------------------------------------

echo &quot;Creating new VM $VM&quot;
New-VM -Name $VM -Generation 2

# Set the CPU and start-up RAM
echo &quot;Setting VM with $cpu CPUs and $ram_bytes bytes RAM&quot;
Set-VM $VM -ProcessorCount $cpu -MemoryStartupBytes $ram_bytes

# Create the new VHDX disk - the path and size.
echo &quot;Creating hard disk &#x27;$path_to_disk&#x27;&quot;
New-VHD -Path &quot;$path_to_disk&quot; -SizeBytes $disk_size

# Add the new disk to the VM
echo &quot;Attaching hard disk to VM&quot; 
Add-VMHardDiskDrive -VMName $VM -Path &quot;$path_to_disk&quot;

$network_adapter = (Get-VMNetworkAdapter -VMName $VM).Name

echo &quot;Connecting Network Adapter &#x27;$network_adapter&#x27; to switch &#x27;$VM_switch&#x27;&quot;
Connect-VMNetworkAdapter -VMName $VM -Name $network_adapter -SwitchName $VM_switch
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kshsetbootorder">
                            <a href="#kshsetbootorder">
                                <strong>Step 1.5.5 -</strong> KSH Set Boot Order
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$VM = &#x27;{targetServer.name}&#x27;

Write-Host &quot;Current boot order for $VM is:&quot;
Get-VMBios $VM

Write-Host &quot;Setting boot order.&quot;
Set-VMBios $VM -StartupOrder @(&quot;IDE&quot;, &quot;CD&quot;, &quot;LegacyNetworkAdapter&quot;, &quot;Floppy&quot;)

Write-Host &quot;Boot order is now:&quot;
Get-VMBios $VM
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="ksdeleteisoonhypervhost">
                            <a href="#ksdeleteisoonhypervhost">
                                <strong>Step 1.5.6 -</strong> KS Delete ISO On Hyper-V Host
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$DIRECTORY=&#x27;{isoFolder}\kickstart_{targetServer.fqn}&#x27;

if (Test-Path $DIRECTORY) {
    cd &quot;$DIRECTORY&quot;
    $ISO = &quot;kickstart_{targetServer.fqn}.iso&quot;
    
    $found = $false
    Get-ChildItem | ForEach-Object {
        $filename=$_.Name
        echo &quot;${i}. ${filename}&quot;
        
        if (${filename} -like $ISO) {
            Write-Host &quot;Found ISO file ${filename}&quot;
            $found=$true
            return
        }
        $i++
    }
    
    if ($found -eq $false) {
        Write-Host &quot;No $ISO found at ${DIRECTORY}, skipping&quot;
    } else {
        Write-Host &quot;Deleting $ISO &quot;
        remove-Item $ISO
        if (Test-Path $ISO) {
            Write-Host &quot;Failed&quot;
        } else {
            Write-Host &quot;Success&quot;   
        }
    }
    
    Write-Host &quot;Deleting folder $DIRECTORY&quot;
    cd ..
    remove-Item $DIRECTORY
    if (Test-Path $DIRECTORY) {
        Write-Host &quot;Failed&quot;
    } else {
        Write-Host &quot;Success&quot;   
    }
    
} else {
    Write-Host &quot;$DIRECTORY does not exist, skipping.&quot;   
}
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kshcreatekickstartfolder">
                            <a href="#kshcreatekickstartfolder">
                                <strong>Step 1.5.7 -</strong> KSH Create Kickstart Folder
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$KICKSTART_FOLDER = &quot;{isoFolder}\kickstart_{targetServer.fqn}&quot;

if (Test-Path $KICKSTART_FOLDER) {
  Write-Host &quot;Kickstart folder $KICKSTART_FOLDER exists, good&quot;
} else {
  Write-Host &quot;Kickstart folder $KICKSTART_FOLDER deos not exist, creating&quot;
  New-Item $KICKSTART_FOLDER -ItemType Directory
  if (Test-Path $KICKSTART_FOLDER) {
    Write-Host &quot;Kickstart folder $KICKSTART_FOLDER created.&quot;
  }
}
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kshhypervpulliso">
                            <a href="#kshhypervpulliso">
                                <strong>Step 1.5.8 -</strong> KSH Hyper-V Pull ISO
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            <p>Usage of DownloadFile() is from https://superuser.com/questions/362152/native-alternative-to-wget-in-windows-powershell</p>
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$CLIENT = New-Object System.Net.WebClient

$ISO_FILE = &quot;kickstart_{targetServer.fqn}.iso&quot;

$URL = &quot;http://{attuneOsBuildServer.ip}:8050/$ISO_FILE&quot;
$PATH = &quot;c:\ProgramData\Microsoft\Windows\isos\kickstart_{targetServer.fqn}\$ISO_FILE&quot;

$CLIENT.DownloadFile($URL, $PATH)
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kshchecksha256sum">
                            <a href="#kshchecksha256sum">
                                <strong>Step 1.5.9 -</strong> KSH Check SHA256 Sum
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {linuxattuneuser}@{attuneosbuildserver}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
cd {ksVmwareAttuneBaseDir}

pwsh &lt;&lt;&#x27;EOF&#x27;

Write-Host &quot;pwd&quot;
pwd

$ISO = &#x27;kickstart_{targetServer.fqn}.iso&#x27;
Write-Host &quot;ISO=$ISO&quot;

$original_sha256 = (Get-FileHash $ISO).Hash
Write-Host &quot;original_sha256=$original_sha256&quot;

# $userName looks like &#x27;ko1hprv1vs2\kooi&#x27;
$userName = &#x27;{hypervHost.hostname}\{hypervHostUser.user}&#x27;
Write-Host &quot;userName=$userName&quot;

$userPassword = &#x27;{hypervHostUser.password}&#x27;
$secStringPassword = ConvertTo-SecureString $userPassword -AsPlainText -Force

$credObject = New-Object System.Management.Automation.PSCredential `
    ($userName, $secStringPassword)

$session = New-PSSession -ComputerName &#x27;{hypervHost.hostname}&#x27; `
    -Credential $credObject -Authentication Negotiate

$file_path = &quot;{isoFolder}\kickstart_{targetServer.fqn}\$ISO&quot;
Write-Host &quot;file_path=$file_path&quot;

$copied_file_sha256 = (Invoke-Command -Session $session -ScriptBlock { 
    param($file_path) Get-FileHash $file_path 
} -ArgumentList $file_path).Hash

Write-Host &quot;copied_file_sha256=$copied_file_sha256&quot;

if ($copied_file_sha256 -eq $original_sha256) {
    Write-Host &quot;All good, copied file sha256sum matches original.&quot;
} else {
    Write-Error &quot;copied file sha256sum does not match original&quot; -ErrorAction Stop
}

EOF
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kshloadiso">
                            <a href="#kshloadiso">
                                <strong>Step 1.5.10 -</strong> KSH Load ISO
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>










                        <div class="row">
                            <p>
                                Connect via RDP:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
mstsc /admin /v:{hypervhost}
                            </code>
                        </div>
                        <div class="row">
                            <p>
                                Login as user {hypervhostuser} and open a
                                command prompt.
                            </p>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$VM = &#x27;{targetServer.name}&#x27;
$user=&quot;{hypervHostUser.user}&quot;

$directory=&#x27;{isoFolder}\kickstart_{targetServer.fqn}&#x27;
cd &quot;$directory&quot;

$ISO = &quot;kickstart_{targetServer.fqn}.iso&quot;

$found = $false
Get-ChildItem | ForEach-Object {
    $filename=$_.Name
    echo &quot;${i}. ${filename}&quot;
    
    if (${filename} -like $ISO) {
        Write-Host &quot;Found ISO file ${filename}&quot;
        $winpe_iso=${filename}
        $found=$true
        return
    }
    $i++
}

if ($found -eq $false) {
    Write-Error &quot;No $ISO found at ${directory}&quot; -ErrorAction Stop
} else {
    Write-Host &quot;Attaching ${winpe_iso} to first DVD Drive&quot;
    Set-VMDvdDrive -VMName $VM -ControllerNumber 1 -ControllerLocation 0 -Path $winpe_iso
}
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="ksaddvmdvddriveforgeneration2">
                            <a href="#ksaddvmdvddriveforgeneration2">
                                <strong>Step 1.5.11 -</strong> KS Add-VMDvdDrive for Generation 2
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            <p>This adds the DVD Drive and loads the ISO file.</p>
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$VM = &#x27;{targetServer.name}&#x27;
Write-Host &quot;VM = $VM&quot;

$ISO_PATH = &#x27;{isoFolder}\kickstart_{targetServer.fqn}\kickstart_{targetServer.fqn}.iso&#x27;
#$ISO_PATH = &#x27;C:\Users\Administrator\kickstart_{targetServer.fqn}.iso&#x27;

Add-VMDVDDrive -VMName $VM -Path $ISO_PATH

Get-VMDVDDrive -VMName $VM
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kshsetbootorderforgeneration2">
                            <a href="#kshsetbootorderforgeneration2">
                                <strong>Step 1.5.12 -</strong> KSH Set Boot Order for Generation 2
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            <p>Sets boot order and UEFI Secure Boot.</p>
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$VM = &#x27;{targetServer.name}&#x27;

Write-Host &quot;Old boot order for $VM is:&quot;
Get-VMFirmware -VMName $VM

$DVD_DRIVE = Get-VMDVDDrive -VMName $VM
$HARD_DISK_DRIVE = Get-VMHardDiskDrive -VMName $VM

Write-Host &quot;Setting boot order.&quot;
Set-VMFirmware -VMName $VM `
    -BootOrder $HARD_DISK_DRIVE, $DVD_DRIVE `
    -EnableSecureBoot On `
    -SecureBootTemplate &quot;MicrosoftUEFICertificateAuthority&quot;
    
Write-Host &quot;Current boot order for $VM is:&quot;
Get-VMFirmware -VMName $VM
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kshboottoiso">
                            <a href="#kshboottoiso">
                                <strong>Step 1.5.13 -</strong> KSH Boot to ISO
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$VM = &#x27;{targetServer.name}&#x27;
Start-VM $VM

$state = (Get-VM $VM).state
Write-Host &quot;VM state=$state&quot;
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kssshwait">
                            <a href="#kssshwait">
                                <strong>Step 1.5.14 -</strong> KS SSH Wait
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>












    

    <div class="row">
        <p class="mb-0">
            Check if TCP Port <strong>0</strong> is listening.
            When the TCP Port is up, wait <strong>5</strong>
            seconds.
        </p>
        <p>Use Telnet to check if the TCP Service is accepting connections.</p>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kshunloadisofromvm">
                            <a href="#kshunloadisofromvm">
                                <strong>Step 1.5.15 -</strong> KSH Unload ISO from VM
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>










                        <div class="row">
                            <p>
                                Connect via RDP:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
mstsc /admin /v:{hypervhost}
                            </code>
                        </div>
                        <div class="row">
                            <p>
                                Login as user {hypervhostuser} and open a
                                command prompt.
                            </p>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$VM = &#x27;{targetServer.name}&#x27;
Write-Host &quot;$VM&quot;

Set-VMDvdDrive -VMName $VM -ControllerNumber 1 -ControllerLocation 0 -Path &quot;&quot;
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kshremovevmdvddriveforgeneration2">
                            <a href="#kshremovevmdvddriveforgeneration2">
                                <strong>Step 1.5.16 -</strong> KSH Remove-VMDvdDrive for Generation 2
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$VM = &#x27;{targetServer.name}&#x27;
Write-Host &quot;$VM&quot;

Remove-VMDvdDrive -VMName $VM `
    -ControllerNumber 0 -ControllerLocation 1

Get-VMDVDDrive -VMName $VM
                </code>
            </pre>
        </div>
    </div>






    



                    <div class="row pt-5">
                        <h4 id="kscleanbuildfiles">
                            <a href="#kscleanbuildfiles">
                                <strong>Step 1.6 -</strong> KS Clean Build Files
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {linuxattuneuser}@{attuneosbuildserver}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
DIR=&quot;{ksVmwareAttuneBaseDir}/build-{targetServer.fqn}&quot;
[[ -d ${DIR} ]] &amp;&amp; rm -rf ${DIR} &amp;&amp; echo &quot;Removed ${DIR}&quot; || \
    echo &quot;No directory to remove.&quot;

ISO=&quot;{ksVmwareAttuneBaseDir}/kickstart_{targetServer.fqn}.iso&quot;
[[ -f ${ISO} ]] &amp;&amp; rm -fv ${ISO} || echo &quot;No ISO to remove.&quot;
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="ksdeleteisoonhypervhost">
                            <a href="#ksdeleteisoonhypervhost">
                                <strong>Step 1.7 -</strong> KS Delete ISO On Hyper-V Host
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>










                        <div class="row">
                            <p>
                                Connect via RDP:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
mstsc /admin /v:{hypervhost}
                            </code>
                        </div>
                        <div class="row">
                            <p>
                                Login as user {hypervhostuser} and open a
                                command prompt.
                            </p>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$DIRECTORY=&#x27;{isoFolder}\kickstart_{targetServer.fqn}&#x27;

if (Test-Path $DIRECTORY) {
    cd &quot;$DIRECTORY&quot;
    $ISO = &quot;kickstart_{targetServer.fqn}.iso&quot;
    
    $found = $false
    Get-ChildItem | ForEach-Object {
        $filename=$_.Name
        echo &quot;${i}. ${filename}&quot;
        
        if (${filename} -like $ISO) {
            Write-Host &quot;Found ISO file ${filename}&quot;
            $found=$true
            return
        }
        $i++
    }
    
    if ($found -eq $false) {
        Write-Host &quot;No $ISO found at ${DIRECTORY}, skipping&quot;
    } else {
        Write-Host &quot;Deleting $ISO &quot;
        remove-Item $ISO
        if (Test-Path $ISO) {
            Write-Host &quot;Failed&quot;
        } else {
            Write-Host &quot;Success&quot;   
        }
    }
    
    Write-Host &quot;Deleting folder $DIRECTORY&quot;
    cd ..
    remove-Item $DIRECTORY
    if (Test-Path $DIRECTORY) {
        Write-Host &quot;Failed&quot;
    } else {
        Write-Host &quot;Success&quot;   
    }
    
} else {
    Write-Host &quot;$DIRECTORY does not exist, skipping.&quot;   
}
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="linreboot">
                            <a href="#linreboot">
                                <strong>Step 1.8 -</strong> LIN Reboot
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {linuxrootuser}@{targetserverlin}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
nohup shutdown -r now &amp;
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kssshwait">
                            <a href="#kssshwait">
                                <strong>Step 1.9 -</strong> KS SSH Wait
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>












    

    <div class="row">
        <p class="mb-0">
            Check if TCP Port <strong>0</strong> is listening.
            When the TCP Port is up, wait <strong>5</strong>
            seconds.
        </p>
        <p>Use Telnet to check if the TCP Service is accepting connections.</p>
    </div>






        



                    <div class="row pt-5">
                        <h3 id="winpekickstartwin10hyperv">
                            <a href="#winpekickstartwin10hyperv">
                                <strong>Step 2 -</strong> WinPE Kickstart Win10+HyperV
                            </a>
                        </h3>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>





    




    



                    <div class="row pt-5">
                        <h4 id="kscleanbuildfiles">
                            <a href="#kscleanbuildfiles">
                                <strong>Step 2.1 -</strong> KS Clean Build Files
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {linuxattuneuser}@{attuneosbuildserver}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
DIR=&quot;{ksVmwareAttuneBaseDir}/build-{targetServer.fqn}&quot;
[[ -d ${DIR} ]] &amp;&amp; rm -rf ${DIR} &amp;&amp; echo &quot;Removed ${DIR}&quot; || \
    echo &quot;No directory to remove.&quot;

ISO=&quot;{ksVmwareAttuneBaseDir}/kickstart_{targetServer.fqn}.iso&quot;
[[ -f ${ISO} ]] &amp;&amp; rm -fv ${ISO} || echo &quot;No ISO to remove.&quot;
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="ksextractwinpeisoparentlink">
                            <a href="#ksextractwinpeisoparentlink">
                                <strong>Step 2.2 -</strong> KS Extract WinPE ISO - Parent (Link)
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>






    





    



                    <div class="row pt-5">
                        <h4 id="kshypervdeploywin10unattendedconfiglink">
                            <a href="#kshypervdeploywin10unattendedconfiglink">
                                <strong>Step 2.3 -</strong> KS Hyper-V Deploy Win10 Unattended Config (Link)
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>






    





    



                    <div class="row pt-5">
                        <h4 id="modifywinpebootwimforwin10link">
                            <a href="#modifywinpebootwimforwin10link">
                                <strong>Step 2.4 -</strong> Modify WinPE boot.wim for Win10 (Link)
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>






    





    



                    <div class="row pt-5">
                        <h4 id="kswinpecreatebootisoparentlink">
                            <a href="#kswinpecreatebootisoparentlink">
                                <strong>Step 2.5 -</strong> KS WinPE Create Boot ISO - parent (Link)
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>






    





    



                    <div class="row pt-5">
                        <h4 id="kshypervrecreatewinvirtualmachinelink">
                            <a href="#kshypervrecreatewinvirtualmachinelink">
                                <strong>Step 2.6 -</strong> KS Hyper-V Recreate Win Virtual Machine (Link)
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>






    





    



                    <div class="row pt-5">
                        <h4 id="kscleanbuildfiles">
                            <a href="#kscleanbuildfiles">
                                <strong>Step 2.7 -</strong> KS Clean Build Files
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
DIR=&quot;{ksVmwareAttuneBaseDir}/build-{targetServer.fqn}&quot;
[[ -d ${DIR} ]] &amp;&amp; rm -rf ${DIR} &amp;&amp; echo &quot;Removed ${DIR}&quot; || \
    echo &quot;No directory to remove.&quot;

ISO=&quot;{ksVmwareAttuneBaseDir}/kickstart_{targetServer.fqn}.iso&quot;
[[ -f ${ISO} ]] &amp;&amp; rm -fv ${ISO} || echo &quot;No ISO to remove.&quot;
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="ksdeleteisoonhypervhost">
                            <a href="#ksdeleteisoonhypervhost">
                                <strong>Step 2.8 -</strong> KS Delete ISO On Hyper-V Host
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>










                        <div class="row">
                            <p>
                                Connect via RDP:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
mstsc /admin /v:{hypervhost}
                            </code>
                        </div>
                        <div class="row">
                            <p>
                                Login as user {hypervhostuser} and open a
                                command prompt.
                            </p>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$DIRECTORY=&#x27;{isoFolder}\kickstart_{targetServer.fqn}&#x27;

if (Test-Path $DIRECTORY) {
    cd &quot;$DIRECTORY&quot;
    $ISO = &quot;kickstart_{targetServer.fqn}.iso&quot;
    
    $found = $false
    Get-ChildItem | ForEach-Object {
        $filename=$_.Name
        echo &quot;${i}. ${filename}&quot;
        
        if (${filename} -like $ISO) {
            Write-Host &quot;Found ISO file ${filename}&quot;
            $found=$true
            return
        }
        $i++
    }
    
    if ($found -eq $false) {
        Write-Host &quot;No $ISO found at ${DIRECTORY}, skipping&quot;
    } else {
        Write-Host &quot;Deleting $ISO &quot;
        remove-Item $ISO
        if (Test-Path $ISO) {
            Write-Host &quot;Failed&quot;
        } else {
            Write-Host &quot;Success&quot;   
        }
    }
    
    Write-Host &quot;Deleting folder $DIRECTORY&quot;
    cd ..
    remove-Item $DIRECTORY
    if (Test-Path $DIRECTORY) {
        Write-Host &quot;Failed&quot;
    } else {
        Write-Host &quot;Success&quot;   
    }
    
} else {
    Write-Host &quot;$DIRECTORY does not exist, skipping.&quot;   
}
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="winrebootlink">
                            <a href="#winrebootlink">
                                <strong>Step 2.9 -</strong> WIN Reboot (Link)
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>






    





    



                    <div class="row pt-5">
                        <h4 id="winrmhttpswait120s">
                            <a href="#winrmhttpswait120s">
                                <strong>Step 2.10 -</strong> WinRM HTTPS Wait 120s
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>












    

    <div class="row">
        <p class="mb-0">
            Check if TCP Port <strong>0</strong> is listening.
            When the TCP Port is up, wait <strong>120</strong>
            seconds.
        </p>
        <p>Use Telnet to check if the TCP Service is accepting connections.</p>
    </div>






        



                    <div class="row pt-5">
                        <h3 id="winpekickstartwin2019hyperv">
                            <a href="#winpekickstartwin2019hyperv">
                                <strong>Step 3 -</strong> WinPE Kickstart Win2019+HyperV
                            </a>
                        </h3>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>





    




    



                    <div class="row pt-5">
                        <h4 id="kscleanbuildfiles">
                            <a href="#kscleanbuildfiles">
                                <strong>Step 3.1 -</strong> KS Clean Build Files
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {linuxattuneuser}@{attuneosbuildserver}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
DIR=&quot;{ksVmwareAttuneBaseDir}/build-{targetServer.fqn}&quot;
[[ -d ${DIR} ]] &amp;&amp; rm -rf ${DIR} &amp;&amp; echo &quot;Removed ${DIR}&quot; || \
    echo &quot;No directory to remove.&quot;

ISO=&quot;{ksVmwareAttuneBaseDir}/kickstart_{targetServer.fqn}.iso&quot;
[[ -f ${ISO} ]] &amp;&amp; rm -fv ${ISO} || echo &quot;No ISO to remove.&quot;
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h3 id="winpedeploywinpefilesforhyperv">
                            <a href="#winpedeploywinpefilesforhyperv">
                                <strong>Step 3.2 -</strong> WinPE Deploy WinPE Files for HyperV
                            </a>
                        </h3>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>





    




    



                    <div class="row pt-5">
                        <h4 id="kswimlibunmountbootwimifmounted">
                            <a href="#kswimlibunmountbootwimifmounted">
                                <strong>Step 3.2.1 -</strong> KS wimlib Unmount boot.wim if Mounted
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if pgrep wimmountrw
then
    echo &quot;Unmounting {ksVmwareAttuneBaseDir}/build-{targetServer.fqn}/WinPE_BootImageDir&quot;
    cd {ksVmwareAttuneBaseDir}/build-{targetServer.fqn}
    wimunmount WinPE_BootImageDir --commit --check --rebuild
else
    echo &quot;Not mounted, skipping.&quot;
fi
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="kswin2019deploywinpeisohyperv">
                            <a href="#kswin2019deploywinpeisohyperv">
                                <strong>Step 3.2.2 -</strong> KS Win2019 Deploy WinPE ISO Hyper-V
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    

    



    <div class="row">
        <p>
            <p>Taken from nzte1att2 file archive "WinPE 2019 ISO".</p>
        </p>
        <p>
            Copy the File(s)
            <strong>WinPE_ISO_for_Windows_201_HyperV.zip</strong>
            to the target node.
        </p>
        <p>
            <strong>Extract and deploy the File(s)</strong> here:
        </p>
    </div>
    <div class="row py-1">
        <code class="language-bash">
{ksVmwareAttuneBaseDir}/build-{targetServer.fqn}, relative to the home directory
        </code>
    </div>






    



                    <div class="row pt-5">
                        <h4 id="ksextractwinpeisoparentlink">
                            <a href="#ksextractwinpeisoparentlink">
                                <strong>Step 3.3 -</strong> KS Extract WinPE ISO - Parent (Link)
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>






    





    



                    <div class="row pt-5">
                        <h4 id="kshypervdeploywin2019unattendedconfiglink">
                            <a href="#kshypervdeploywin2019unattendedconfiglink">
                                <strong>Step 3.4 -</strong> KS Hyper-V Deploy Win2019 Unattended Config (Link)
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>






    





    



                    <div class="row pt-5">
                        <h4 id="modifywinpebootwimfor2016link">
                            <a href="#modifywinpebootwimfor2016link">
                                <strong>Step 3.5 -</strong> Modify WinPE boot.wim for 2016 (Link)
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>






    





    



                    <div class="row pt-5">
                        <h4 id="kswinpecreatebootisoparentlink">
                            <a href="#kswinpecreatebootisoparentlink">
                                <strong>Step 3.6 -</strong> KS WinPE Create Boot ISO - parent (Link)
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>






    





    



                    <div class="row pt-5">
                        <h4 id="kshypervrecreatewinvirtualmachinelink">
                            <a href="#kshypervrecreatewinvirtualmachinelink">
                                <strong>Step 3.7 -</strong> KS Hyper-V Recreate Win Virtual Machine (Link)
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>






    





    



                    <div class="row pt-5">
                        <h4 id="kscleanbuildfiles">
                            <a href="#kscleanbuildfiles">
                                <strong>Step 3.8 -</strong> KS Clean Build Files
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
DIR=&quot;{ksVmwareAttuneBaseDir}/build-{targetServer.fqn}&quot;
[[ -d ${DIR} ]] &amp;&amp; rm -rf ${DIR} &amp;&amp; echo &quot;Removed ${DIR}&quot; || \
    echo &quot;No directory to remove.&quot;

ISO=&quot;{ksVmwareAttuneBaseDir}/kickstart_{targetServer.fqn}.iso&quot;
[[ -f ${ISO} ]] &amp;&amp; rm -fv ${ISO} || echo &quot;No ISO to remove.&quot;
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="ksdeleteisoonhypervhost">
                            <a href="#ksdeleteisoonhypervhost">
                                <strong>Step 3.9 -</strong> KS Delete ISO On Hyper-V Host
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>










                        <div class="row">
                            <p>
                                Connect via RDP:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
mstsc /admin /v:{hypervhost}
                            </code>
                        </div>
                        <div class="row">
                            <p>
                                Login as user {hypervhostuser} and open a
                                command prompt.
                            </p>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$DIRECTORY=&#x27;{isoFolder}\kickstart_{targetServer.fqn}&#x27;

if (Test-Path $DIRECTORY) {
    cd &quot;$DIRECTORY&quot;
    $ISO = &quot;kickstart_{targetServer.fqn}.iso&quot;
    
    $found = $false
    Get-ChildItem | ForEach-Object {
        $filename=$_.Name
        echo &quot;${i}. ${filename}&quot;
        
        if (${filename} -like $ISO) {
            Write-Host &quot;Found ISO file ${filename}&quot;
            $found=$true
            return
        }
        $i++
    }
    
    if ($found -eq $false) {
        Write-Host &quot;No $ISO found at ${DIRECTORY}, skipping&quot;
    } else {
        Write-Host &quot;Deleting $ISO &quot;
        remove-Item $ISO
        if (Test-Path $ISO) {
            Write-Host &quot;Failed&quot;
        } else {
            Write-Host &quot;Success&quot;   
        }
    }
    
    Write-Host &quot;Deleting folder $DIRECTORY&quot;
    cd ..
    remove-Item $DIRECTORY
    if (Test-Path $DIRECTORY) {
        Write-Host &quot;Failed&quot;
    } else {
        Write-Host &quot;Success&quot;   
    }
    
} else {
    Write-Host &quot;$DIRECTORY does not exist, skipping.&quot;   
}
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="winrebootlink">
                            <a href="#winrebootlink">
                                <strong>Step 3.10 -</strong> WIN Reboot (Link)
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>






    





    



                    <div class="row pt-5">
                        <h4 id="winrmhttpswait120s">
                            <a href="#winrmhttpswait120s">
                                <strong>Step 3.11 -</strong> WinRM HTTPS Wait 120s
                            </a>
                        </h4>
                    </div>

                    <div class="blueprint-description row">
                        <p>
                            
                        </p>
                    </div>












    

    <div class="row">
        <p class="mb-0">
            Check if TCP Port <strong>0</strong> is listening.
            When the TCP Port is up, wait <strong>120</strong>
            seconds.
        </p>
        <p>Use Telnet to check if the TCP Service is accepting connections.</p>
    </div>







                    <div class="row pt-5">
                        <div class="col">
                            <h3>Completed</h3>
                            <p>
                                You have completed this instruction.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

<!-- Download Attune Ad -->

            <div class="col-lg-2 px-0">
                <div class="container px-0 pt-3 pl-5 sticky-top">
                    <div class="card border-light mb-3" style="max-width: 18rem;">
                        <div class="card-body attune-ad">
                            <img
                                src="https://www.servertribe.com/wp-content/uploads/2022/06/AttuneLogoV2_powered_by.png"
                                alt="Attune - Powered by ServerTribe"
                                class="img-fluid">
                            <h5 class="card-title mt-3 text-center">
                                Automate with Attune
                            </h5>
                            <p class="card-text text-left">
                                Download the Attune Community Edition.
                            </p>
                            <p class="text-center">
                                <a href="https://www.servertribe.com/download-attune-registration/"
                                   class="btn btn-primary mt-3">
                                    DOWNLOAD!!!
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

<!-- Join Discord -->

        <div class="row py-5">
            <div class="jumbotron">
                <h1 class="display-4 text-center">
                    Discuss this Instruction in Discord
                </h1>
                <p class="lead">

                    Join our Discord channel and connect with like-minded
                    individuals who
                    share your passion. Engage in lively discussions, gain
                    valuable insights,
                    and stay updated on the latest trends in our industry. Don't
                    miss out on
                    this opportunity to network, learn, and grow together.
                </p>
                <hr class="my-4 text-center">
                <div class="col px-0">
                    <p class="text-center">
                        Click the link below and become a part of our vibrant
                        community on
                        Discord today!
                    </p>
                    <p class="lead text-center">
                        <a class="btn btn-primary btn-lg"
                           href="https://discord.com/invite/3YpJsagqUn"
                           role="button">
                            Join NOW!!!
                        </a>
                    </p>
                </div>
            </div>
        </div>

    </div>
</div>


<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script
    src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>

<script
    src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script
    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>


</body>
</html>
